{% extends 'base.html' %}
{% load sales_tags %}
{% block title %}{{ object }}{% endblock %}
{% block jumbotron %}
    <h2 class="page-header">{{ object.order }}
        <small>{{ object.get_status_display }}</small>
        <small><span class="glyphicon glyphicon-shopping-cart">{{ object.pickup_progress }}</span>
        </small>
        <small>{% if object.is_proceeds %}
            <span class="glyphicon glyphicon-yen"></span>{% endif %}</small>
    </h2>{% endblock %}
{% block main %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">订单信息{% if limits.edit %}<a class="btn btn-link" href=
                    "{% url 'sales:order_update_info' object.id %}">
                修改
            </a>{% endif %}</h3>
            <div class="panel-body">
                <ul>
                    <li>订单号:{{ object.order }}</li>
                    <li>日期:{{ object.date }}</li>
                    <li>客户名称: <a href="{{ object.customer.get_absolute_url }}">
                        {{ object.customer }}</a>
                    </li>
                    <li>经办人:{{ object.handler }}</li>
                    <li>销往:{{ object.province }}-{{ object.city }}</li>
                    {% if object.verifier %}
                        <li>审核人:{{ object.verifier }}</li>
                        <li>审核日期:{{ object.verify_date }}</li>
                    {% endif %}
                    <li>备注信息:{{ object.ps }}</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">订单货品信息 <span class="badge">{{ object.items.all|length }}</span>
                {% if limits.edit %}<a class="btn btn-link" href=
                        "{% url 'sales:order_update_item' object.id %}">
                    修改
                </a>{% endif %}</h3>
            <div class="panel-body">
                {% if item_list %}
                    <table class="table">
                        <tr>
                            <th width="11%">#</th>
                            <th>荒料编号</th>
                            <th>厚度</th>
                            <th>夹数</th>
                            <th>件数</th>
                            <th>数量</th>
                            <th>单价</th>
                            <th>小计</th>
                            <th>码单</th>

                        </tr>

                        {% for object,list in item_list %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <a href="{{ object.block_num.get_absolute_url }}">{{ object.block_num }}</a>
                                </td>
                                <td>{{ object.thickness }}</td>
                                <td>{{ object.part }}</td>
                                <td>{{ object.pic }}</td>
                                <td>{{ object.quantity }}{{ object.unit }}</td>
                                <td>{{ object.price }}</td>
                                <td>{{ object.sum }}</td>
                                <td>
                                    <div class="dropdown">
                                        <a href="#" data-target="#" class="dropdown-toggle"
                                           data-toggle="dropdown" role="button"
                                           aria-haspopup="true"
                                           aria-expanded="false"><span class="glyphicon glyphicon-option-horizontal"></span></a>
                                        <ul class="dropdown-menu">
                                            <li><a
                                                    href="{% url 'product:slab_list'  object.block_num %}">修改</a>
                                            </li>
                                            <li role="separator" class="divider"></li>
                                            <li>
                                                <a class="btn btn-info"
                                                        onclick="gogo_slab_list('{{ list.block_num }}',
                                                                '{{ list.thickness }}','{{ list.ids }}','{% url "product:order_slab_list" %}')">
                                                    新页面打开
                                                </a>
                                                <a href="{% url 'product:slab_list'  object.block_num %}?slab_ids={{ object.slab_ids }}">打开</a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                        <tr>
                            <th width="11%">总计：</th>
                            <th>{{ total_count }}</th>
                            <th></th>
                            <th>{{ total_part }}</th>
                            <th>{{ total_pic }}</th>
                            <th>{% for unit, quantity in total_quantity.items %}
                                {{ quantity }}{{ unit }}
                                {% if forloop.last %}{% else %}<br>{% endif %}
                            {% endfor %}</th>
                            <th></th>
                            <th>{{ object.amount }}</th>
                            <th></th>
                        </tr>
                    </table>
                {% endif %}
            </div>
        </div>
    </div>
    {% if can_pickup_item_list %}
        {% if limits.pickup %}
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">可提货数量 <span
                            class="badge">{{ can_pickup_item_list|length }}</span>
                        {% if limits.pickup %}<a
                                class="btn btn-link" href=
                                "{% url 'sales:pickup_create' object.id %}">
                            提货
                        </a>{% endif %}</h3></div>
                <div class="panel-body">
                    {% if item_list %}
                        <table class="table">
                            <tr>

                                <th width="11%">#</th>
                                <th>荒料编号</th>
                                <th>厚度</th>
                                <th>夹数</th>
                                <th>件数</th>
                                <th>数量</th>
                                <th>码单</th>
                            </tr>

                            {% for object in can_pickup_item_list %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <a href="{{ object.block_num.get_absolute_url }}">{{ object.block_num }}</a>
                                    </td>
                                    <td>{{ object.thickness }}</td>
                                    <td>{{ object.part_count }}</td>
                                    <td>{{ object.block_pics }}</td>
                                    <td>{{ object.quantity }}{{ object.unit }}</td>
                                    <td>
                                        <div class="dropdown">
                                            <a href="#" data-target="#" class="dropdown-toggle"
                                               data-toggle="dropdown" role="button"
                                               aria-haspopup="true"
                                               aria-expanded="false"><span class="glyphicon glyphicon-option-horizontal"></span></a>
{#                                            <span class="caret"></span>#}
                                            <ul class="dropdown-menu">
                                                <li><a
                                                        href="{% url 'product:slab_list'  object.block_num %}">修改</a>
                                                </li>
                                                <li role="separator" class="divider"></li>
                                                <li>
                                                    <button class="btn btn-info"
                                                            onclick="gogo_slab_list('{{ object.block_num }}',
                                                                    '{{ object.thickness }}','{{ object.ids }}',
                                                                    '{% url "product:order_slab_list" %}')">
                                                        新页面打开
                                                    </button>
                                                    <a href="{% url 'product:slab_list'  object.block_num %}?slab_ids={{ object.slab_ids }}">打开</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr>
                                <th width="11%">总计：</th>
                                <th>{{ can_pickup_total_count }}</th>
                                <th></th>
                                <th>{{ can_pickup_total_part }}</th>
                                <th>{{ can_pickup_total_pic }}</th>
                                <th>{% for unit, quantity in can_pickup_total_quantity.items %}
                                    {{ quantity }}{{ unit }}{% if forloop.last %}{% else %}<br>
                                    {% endif %}{% endfor %}</th>
                                <th></th>
                            </tr>
                        </table>
                    {% endif %}
                </div>

            </div>
        {% endif %}{% endif %}
    {% if already_pickup_list %}
        <div class="panel panel-warning">
            <div class="panel-heading">
                <h3 class="panel-title">已提货记录 <span
                        class="badge">{{ already_pickup_list|length }}</span>
                </h3></div>
            <div class="panel-body">
                <table class="table">
                    <tr>
                        <th width="11%">#</th>
                        <th>日期</th>
                        <th>车牌</th>
                        <th>提货数量</th>
                        <th>总花费</th>
                        <th>操作</th>
                    </tr>
                    {% for item in already_pickup_list %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ item.date }}</td>
                            <td>{{ item.cart_num }}</td>
                            <td>
                                {% for unit, quantity in item.total_quantity.items %}
                                    {{ quantity }}{{ unit }}
                                {% endfor %}
                            </td>
                            <td>{{ item.total_cost }}</td>

                            <td>
                                <a href="{{ item.get_absolute_url }}">打开</a>
                            </td>
                        </tr>

                    {% endfor %}
                </table>
            </div>
        </div>
    {% endif %}
    {% if proceeds_list %}
        <div class="panel panel-success">
            <div class="panel-heading">
                <h3 class="panel-title">收款记录
                    <span class="badge">{{ already_pickup_list|length }}</span>
                </h3></div>
            <div class="panel-body">
                <table class="table">
                    <tr>
                        <th width="11%">#</th>
                        <th>日期</th>
                        <th>金额</th>
                        <th>支付方式</th>
                        <th>款项类型</th>
                        <th>登记人</th>
                        <th>操作</th>
                    </tr>
                    {% for item in proceeds_list %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ item.date }}</td>
                            <td>{{ item.amount }}</td>
                            <td>{{ item.get_method_display }}</td>
                            <td>{{ item.get_type_display }}</td>
                            <td>{{ item.data_entry_staff }}</td>
                            <td>
                                <a href="{{ item.get_absolute_url }}">打开</a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    {% endif %}
    {% if extra_cost_list %}
        <div class="panel panel-warning">
            <div class="panel-heading">
                <h3 class="panel-title">额外成本
                    <span class="badge">{{ extra_cost_list|length }}</span>
                </h3></div>
            <div class="panel-body">
                <table class="table">
                    <tr>
                        <th width="11%">#</th>
                        <th>日期</th>
                        <th>金额</th>
                        <th>项目</th>
                        <th>补充说明</th>
                        <th>经办人</th>
                        <th>操作</th>
                    </tr>
                    {% for item in extra_cost_list %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ item.date }}</td>
                            <td>{{ item.amount }}</td>
                            <td>{{ item.get_item_display }}</td>
                            <td>{{ item.desc }}</td>
                            <td>{{ item.data_entry_staff }}</td>
                            <td>
                                <a href="{{ item.get_absolute_url }}">打开</a>
                            </td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block sidebar %}
    {% about_this_order object.id %}
    {% if extra_info %}
        <div class="panel panel-warning">
            <div class="panel-heading">
                <div class="panel-body">
                    {{ extra_info.info }}
                    {% if extra_info.show %}
                        <input form="verify" class="btn btn-danger"  type="submit"
                               name="{{ extra_info.done_button_name }}" value="是">
                    {% endif %}
                    <input form="verify" class="btn btn-default" type="submit"
                           name="no" value="否">
                </div>
            </div>
        </div>
    {% endif %}
    <form action="" method="post" id="verify">
        {% if limits.verify %}
            <input class="btn btn-primary" type="submit" name="verify" value="审核订单">
        {% endif %}
        {% if limits.cancel %}
            <input class="btn btn-warning" type="submit" name="cancel" value="撤销审核">
        {% endif %}
        {% if limits.close %}
            <input class="btn btn-danger" type="submit" name="close" value="关闭订单">
        {% endif %}
        {% if limits.is_proceeds %}
            <input class="btn btn-success" formmethod="get" type="submit" name="is_proceeds"
                   value="完成收款">
        {% endif %}
        {% csrf_token %}
    </form>
    {% if limits.proceeds %}
        <a class="btn btn-default" href="{% url 'sales:proceeds_create' object.id %}">登记收款</a>
        <a class="btn btn-default" href="{% url 'sales:extra_cost_create' object.id %}">登记额外成本</a>
    {% endif %}
    <script>
        function is_proceeds() {
            $.ajax({
                    type: "POST",
                    url: "{% url 'sales:order_is_proceeds' object.id %}",
                    data: {
                        'is_proceeds': '1' // from form
                    }
                    ,
                    success: function (data) {
                        alert(data)
                    }
                }
            )
            ;
        }
    </script>
{% endblock %}